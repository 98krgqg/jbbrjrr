
-- 基础服务
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Camera = Workspace.CurrentCamera

-- 关闭摄像机震动
pcall(function()
    local ok, main = pcall(function()
        return require(ReplicatedStorage:FindFirstChild("Util") and ReplicatedStorage.Util:FindFirstChild("CameraShaker") and ReplicatedStorage.Util.CameraShaker:FindFirstChild("Main") or nil)
    end)
    if ok and type(main) == "table" then
        local returnnil = function() return nil end
        main.StartShake = returnnil
        main.ShakeOnce = returnnil
        main.ShakeSustain = returnnil
        main.CameraShakeInstance = returnnil
        main.Shake = returnnil
        main.Start = returnnil
    end
end)

-- 通知加载
pcall(function()
    StarterGui:SetCore("SendNotification",{
        Title = "人挤人脚本",
        Text = "加载中...",
        Duration = 3,
    })
end)

-- 全局设置
local _ENV = (getgenv or getrenv or getfenv)()
local MIN_CLICK_DELAY = 0.0005
local Settings = {AutoClick = true, ClickDelay = 0.3} -- 攻速 0.3
local _G = _G or getfenv(0)._G
_G.FastAttack = _G.FastAttack ~= nil and _G.FastAttack or true

-- Helper
local function SafeWaitForChild(parent, childName, timeout)
    timeout = timeout or 10
    local ok, res = pcall(function() return parent:WaitForChild(childName, timeout) end)
    if ok then return res end
    return nil
end

local function IsAlive(character)
    if not character then return false end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    return humanoid and humanoid.Health and humanoid.Health > 0
end

local function GetRandomValidPart(target)
    if not target then return nil end
    local allParts = target:GetDescendants()
    local validParts = {}
    local humanoidRootPart = target:FindFirstChild("HumanoidRootPart")
    local boneParts = humanoidRootPart and humanoidRootPart.Parent and humanoidRootPart.Parent:GetDescendants() or {}
    for _, part in ipairs(allParts) do
        if part:IsA("BasePart") and part.CanCollide and table.find(boneParts, part) then
            table.insert(validParts, part)
        end
    end
    return #validParts > 0 and validParts[math.random(1, #validParts)] or target:FindFirstChild("HumanoidRootPart")
end

-- 检索核心组件
local function CheckAndGetCoreComponents()
    local Remotes, Modules, Net, RegisterAttack, RegisterHit, Enemies = nil, nil, nil, nil, nil, nil
    while true do
        Remotes = SafeWaitForChild(ReplicatedStorage, "Remotes", 2)
        Modules = SafeWaitForChild(ReplicatedStorage, "Modules", 2)
        Net = Modules and SafeWaitForChild(Modules, "Net", 2) or nil
        RegisterAttack = Net and SafeWaitForChild(Net, "RE/RegisterAttack", 2) or nil
        RegisterHit = Net and SafeWaitForChild(Net, "RE/RegisterHit", 2) or nil
        Enemies = SafeWaitForChild(Workspace, "Enemies", 2)
        if Remotes and Modules and Net and RegisterAttack and RegisterHit and Enemies then
            return Remotes, Net, RegisterAttack, RegisterHit, Enemies
        end
        task.wait(1)
    end
end

-- FastAttack 模块（距离 2500）
local Module = {}
Module.FastAttack = (function()
    if _ENV.rz_FastAttack then return _ENV.rz_FastAttack end
    local FastAttack = {
        Distance = 2500, -- 距离 2500
        attackMobs = true,
        attackPlayers = true,
        Equipped = nil,
        IsRunning = _G.FastAttack,
        consecutiveFailures = 0,
        maxConsecutiveFailures = 5
    }

    local function ProcessEnemies(OthersEnemies, Folder)
        if not Folder or not FastAttack.attackMobs then return nil end
        local BasePart = nil
        for _, Enemy in ipairs(Folder:GetChildren()) do
            if Enemy == LocalPlayer.Character or not IsAlive(Enemy) then continue end
            local foundPart = GetRandomValidPart(Enemy)
            if foundPart and (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and (LocalPlayer.Character.HumanoidRootPart.Position - foundPart.Position).Magnitude < FastAttack.Distance) then
                table.insert(OthersEnemies, {Enemy, foundPart})
                BasePart = foundPart
            end
        end
        return BasePart
    end

    local function ProcessRealPlayers(OthersEnemies)
        if not FastAttack.attackPlayers then return nil end
        local BasePart = nil
        for _, OtherPlayer in ipairs(Players:GetPlayers()) do
            if OtherPlayer == LocalPlayer then continue end
            local OtherChar = OtherPlayer.Character
            if not IsAlive(OtherChar) then continue end
            local foundPart = GetRandomValidPart(OtherChar)
            if foundPart and (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and (LocalPlayer.Character.HumanoidRootPart.Position - foundPart.Position).Magnitude < FastAttack.Distance) then
                table.insert(OthersEnemies, {OtherChar, foundPart})
                BasePart = foundPart
            end
        end
        return BasePart
    end

    function FastAttack:Attack(BasePart, OthersEnemies)
        local _, Net, temp_RegisterAttack, temp_RegisterHit, _ = CheckAndGetCoreComponents()
        if not (BasePart and OthersEnemies and #OthersEnemies > 0 and temp_RegisterAttack and temp_RegisterHit) then
            self.consecutiveFailures = self.consecutiveFailures + 1
            if self.consecutiveFailures >= self.maxConsecutiveFailures then
                self.consecutiveFailures = 0
                self.Equipped = LocalPlayer.Character and IsAlive(LocalPlayer.Character) and LocalPlayer.Character:FindFirstChildOfClass("Tool")
            end
            task.delay(0.5, function() self:AttackNearest() end)
            return
        end
        self.consecutiveFailures = 0
        temp_RegisterAttack:FireServer(Settings.ClickDelay or MIN_CLICK_DELAY)
        temp_RegisterHit:FireServer(BasePart, OthersEnemies)
    end

    function FastAttack:AttackNearest()
        if not self.IsRunning then return end
        local _, _, _, _, Enemies = CheckAndGetCoreComponents()
        local OthersEnemies = {}
        local Part1 = ProcessEnemies(OthersEnemies, Enemies)
        local Part2 = ProcessRealPlayers(OthersEnemies)
        if #OthersEnemies > 0 then
            self:Attack(Part1 or Part2, OthersEnemies)
        end
    end

    function FastAttack:BladeHits()
        if not self.IsRunning then return end
        local Equipped = LocalPlayer.Character and IsAlive(LocalPlayer.Character) and LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if Equipped and Equipped.ToolTip ~= "Gun" then
            self:AttackNearest()
        end
    end

    task.spawn(function()
        while true do
            task.wait(Settings.ClickDelay)
            if Settings.AutoClick and FastAttack.IsRunning then
                FastAttack:BladeHits()
            else
                task.wait()
            end
        end
    end)

    _ENV.rz_FastAttack = FastAttack
    return FastAttack
end)()

-- 恢复逻辑
task.spawn(function()
    while true do
        task.wait(1)
        if not _ENV.rz_FastAttack then
            while not _ENV.rz_FastAttack do
                task.wait(0.5)
                if _G.FastAttack then
                    _ENV.rz_FastAttack = Module.FastAttack or _ENV.rz_FastAttack
                end
            end
        end
    end
end)

-- 自动 v4
-- 定义核心调用函数，确保每次都获取最新的对象
local function callAwakeningRemote()
    -- 1. 确保获取最新的本地玩家实例（复活后实例可能刷新）
    local localPlayer = game.Players.LocalPlayer
    if not localPlayer then return end
    
    -- 2. 等待玩家加载完成（复活后可能有短暂的加载延迟）
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    if not character then return end
    
    -- 3. 查找背包和觉醒对象（每次调用都重新查找，避免引用失效）
    local Backpack = localPlayer:FindFirstChild("Backpack")
    if not Backpack then return end
    
    local Awakening = Backpack:FindFirstChild("Awakening")
    if not Awakening then return end
    
    local RemoteFunc = Awakening:FindFirstChild("RemoteFunction")
    if not RemoteFunc or not RemoteFunc:IsA("RemoteFunction") then return end
    
    -- 4. 安全调用远程函数
    local success, result = pcall(function() 
        RemoteFunc:InvokeServer(true) 
    end)
    if not success then
        warn("调用觉醒远程函数失败：", result)
    end
end

-- 监听玩家复活事件（CharacterAdded 事件在复活/重生时触发）
local function onCharacterAdded(character)
    -- 等待角色完全加载（确保Humanoid等核心组件就绪）
    local humanoid = character:WaitForChild("Humanoid")
    -- 延迟1秒执行，确保背包等对象完全创建
    task.wait(1)
    callAwakeningRemote()
end

-- 绑定事件：首次加载+每次复活都触发
local localPlayer = game.Players.LocalPlayer
if localPlayer.Character then
    onCharacterAdded(localPlayer.Character)
end
localPlayer.CharacterAdded:Connect(onCharacterAdded)

-- 移动加速
getfenv().translateSpeed = 50
getfenv().translateAccelEnabled = false
getfenv().translateConnection = nil

local function enableTranslateAccel(enabled)
    getfenv().translateAccelEnabled = enabled
    if enabled then
        if getfenv().translateConnection then getfenv().translateConnection:Disconnect(); getfenv().translateConnection = nil end
        getfenv().translateConnection = RunService.Heartbeat:Connect(function()
            local char = LocalPlayer.Character
            if char and char:FindFirstChild("Humanoid") and char:FindFirstChild("HumanoidRootPart") then
                local humanoid = char.Humanoid
                if humanoid.MoveDirection.Magnitude > 0 then
                    local moveDirection = humanoid.MoveDirection
                    local acceleration = moveDirection * (getfenv().translateSpeed or 50) / 30
                    char:TranslateBy(acceleration)
                end
            end
        end)
    else
        if getfenv().translateConnection then getfenv().translateConnection:Disconnect(); getfenv().translateConnection = nil end
    end
end

-- ESP
local ESPConfig = {
    MainSwitch = false,
    ShowNameDistance = false,
    ShowTracer = false,
    ShowHealth = false
}

local ESPElements = {}

local function CleanupPlayerESP(player)
    if not ESPElements[player.UserId] then return end
    local e = ESPElements[player.UserId]
    if e.NameHealthESP then
        pcall(function() e.NameHealthESP:Destroy() end)
        e.NameHealthESP = nil
    end
    if e.NameHealthUpdateConn then
        pcall(function() e.NameHealthUpdateConn:Disconnect() end)
        e.NameHealthUpdateConn = nil
    end
    if e.Tracer then
        pcall(function() e.Tracer:Remove() end)
        e.Tracer = nil
    end
    if e.TracerConn then
        pcall(function() e.TracerConn:Disconnect() end)
        e.TracerConn = nil
    end
    ESPElements[player.UserId] = nil
end

local function CreateNameDistanceHealthESP(player)
    if not player.Character or not player.Character:FindFirstChild("Head") then return end
    local head = player.Character.Head
    if ESPElements[player.UserId] and ESPElements[player.UserId].NameHealthESP then
        ESPElements[player.UserId].NameHealthESP:Destroy()
    end

    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "NameDistanceHealthESP"
    billboardGui.Adornee = head
    billboardGui.Size = UDim2.new(0, 120, 0, 50)
    billboardGui.StudsOffset = Vector3.new(0, 3.5, 0)
    billboardGui.AlwaysOnTop = true
    billboardGui.Parent = head

    local nameLabel = Instance.new("TextLabel", billboardGui)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = player.Name
    nameLabel.Size = UDim2.new(1, 0, 0, 16)
    nameLabel.TextColor3 = Color3.new(1, 1, 1)
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.GothamSemibold

    local healthLabel = Instance.new("TextLabel", billboardGui)
    healthLabel.BackgroundTransparency = 1
    healthLabel.Position = UDim2.new(0, 0, 0.33, 0)
    healthLabel.Size = UDim2.new(1, 0, 0, 16)
    healthLabel.TextColor3 = Color3.new(0, 1, 0)
    healthLabel.TextScaled = true
    healthLabel.Font = Enum.Font.Gotham

    local distanceLabel = Instance.new("TextLabel", billboardGui)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Position = UDim2.new(0, 0, 0.66, 0)
    distanceLabel.Size = UDim2.new(1, 0, 0, 16)
    distanceLabel.TextColor3 = Color3.new(1, 0.5, 0)
    distanceLabel.TextScaled = true
    distanceLabel.Font = Enum.Font.Gotham

    local updateConnection = RunService.RenderStepped:Connect(function()
        if not billboardGui.Parent or not LocalPlayer.Character or not player.Character then return end
        local localRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
        if localRoot and targetRoot then
            local distance = (localRoot.Position - targetRoot.Position).Magnitude
            distanceLabel.Text = string.format("%.1f米", distance)
        end
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if humanoid then
            local health = math.floor(humanoid.Health)
            local maxHealth = math.floor(humanoid.MaxHealth)
            local healthPercent = (maxHealth > 0) and (health / maxHealth) or 0
            if healthPercent > 0.7 then
                healthLabel.TextColor3 = Color3.new(0, 1, 0)
            elseif healthPercent > 0.3 then
                healthLabel.TextColor3 = Color3.new(1, 1, 0)
            else
                healthLabel.TextColor3 = Color3.new(1, 0, 0)
            end
            healthLabel.Text = string.format("血量: %d/%d", health, maxHealth)
        end
    end)

    ESPElements[player.UserId] = ESPElements[player.UserId] or {}
    ESPElements[player.UserId].NameHealthESP = billboardGui
    ESPElements[player.UserId].NameHealthUpdateConn = updateConnection
end

local function CreateTracerESP(player)
    if ESPElements[player.UserId] and ESPElements[player.UserId].Tracer then
        pcall(function() ESPElements[player.UserId].Tracer:Remove() end)
    end
    local tracer = Drawing.new("Line")
    tracer.Color = Color3.new(1, 0, 0)
    tracer.Thickness = 2
    tracer.Transparency = 0.8
    tracer.Visible = false

    local renderConnection = RunService.RenderStepped:Connect(function()
        if not ESPConfig.MainSwitch or not ESPConfig.ShowTracer then
            tracer.Visible = false
            return
        end
        local localChar = LocalPlayer.Character
        local targetChar = player.Character
        if not localChar or not targetChar then tracer.Visible = false; return end
        local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
        if targetRoot then
            local screenPos, isVisible = Camera:WorldToViewportPoint(targetRoot.Position)
            if isVisible then
                tracer.Visible = true
                tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
                tracer.To = Vector2.new(screenPos.X, screenPos.Y)
            else
                tracer.Visible = false
            end
        else
            tracer.Visible = false
        end
    end)

    ESPElements[player.UserId] = ESPElements[player.UserId] or {}
    ESPElements[player.UserId].Tracer = tracer
    ESPElements[player.UserId].TracerConn = renderConnection
end

local function UpdatePlayerESP(player)
    if player == LocalPlayer then return end
    if not player.Character then
        CleanupPlayerESP(player)
        return
    end
    if not player.Character:FindFirstChild("Head") or not player.Character:FindFirstChild("HumanoidRootPart") then
        CleanupPlayerESP(player)
        return
    end
    if ESPConfig.MainSwitch then
        if ESPConfig.ShowTracer then CreateTracerESP(player) end
        if ESPConfig.ShowNameDistance or ESPConfig.ShowHealth then
            CreateNameDistanceHealthESP(player)
        else
            if ESPElements[player.UserId] and ESPElements[player.UserId].NameHealthESP then
                pcall(function() ESPElements[player.UserId].NameHealthESP:Destroy() end)
                ESPElements[player.UserId].NameHealthESP = nil
            end
            if ESPElements[player.UserId] and ESPElements[player.UserId].NameHealthUpdateConn then
                pcall(function() ESPElements[player.UserId].NameHealthUpdateConn:Disconnect() end)
                ESPElements[player.UserId].NameHealthUpdateConn = nil
            end
        end
    else
        CleanupPlayerESP(player)
    end
end

local function UpdateAllESP()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            UpdatePlayerESP(player)
        end
    end
end

Players.PlayerAdded:Connect(function(player)
    if player == LocalPlayer then return end
    if player.Character then
        task.spawn(function() task.wait(0.5); UpdatePlayerESP(player) end)
    end
    player.CharacterAdded:Connect(function() task.spawn(function() task.wait(0.5); UpdatePlayerESP(player) end) end)
    player.CharacterRemoving:Connect(function() CleanupPlayerESP(player) end)
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    UpdateAllESP()
end)

task.spawn(function()
    while true do
        task.wait(3)
        if ESPConfig.MainSwitch then UpdateAllESP() end
    end
end)

-- 传送
local function TeleportTo(position)
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(position)
    end
end

-- ===================== 悬浮球 + 居中可拖动窗口 =====================
local function createFloatingGui()
    local existing = PlayerGui:FindFirstChild("RenJiRenFloatingGui")
    if existing then existing:Destroy() end

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "RenJiRenFloatingGui"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = PlayerGui
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.DisplayOrder = 9999

    -- 悬浮球按钮
    local floatBtn = Instance.new("TextButton")
    floatBtn.Name = "FloatingButton"
    floatBtn.Parent = screenGui
    floatBtn.Size = UDim2.new(0, 50, 0, 50)
    floatBtn.Position = UDim2.new(0.9, -60, 0.8, -60)
    floatBtn.BackgroundColor3 = Color3.fromRGB(50, 100, 200)
    floatBtn.Text = "☰"
    floatBtn.TextColor3 = Color3.new(1,1,1)
    floatBtn.Font = Enum.Font.GothamBold
    floatBtn.TextSize = 24
    floatBtn.BorderSizePixel = 0
    floatBtn.Active = true
    floatBtn.Draggable = true

    -- 圆形
    local corner = Instance.new("UICorner")
    corner.Parent = floatBtn
    corner.CornerRadius = UDim.new(1, 0)

    -- 功能窗口
    local window = Instance.new("Frame")
    window.Name = "MainWindow"
    window.Parent = screenGui
    window.Size = UDim2.new(0, 350, 0, 650) -- 增大窗口高度以容纳新按钮
    window.Position = UDim2.new(0.5, -175, 0.5, -325) -- 屏幕正中间
    window.BackgroundColor3 = Color3.fromRGB(20,20,20)
    window.BackgroundTransparency = 0.1
    window.BorderSizePixel = 0
    window.Visible = false

    -- 窗口圆角
    local winCorner = Instance.new("UICorner")
    winCorner.Parent = window
    winCorner.CornerRadius = UDim.new(0.1, 0)

    -- 标题栏（用于拖动）
    local titleBar = Instance.new("TextLabel")
    titleBar.Parent = window
    titleBar.Size = UDim2.new(1,0,0,35)
    titleBar.BackgroundColor3 = Color3.fromRGB(40,40,40)
    titleBar.Text = "人挤人中心（点击标题栏拖动）"
    titleBar.TextColor3 = Color3.new(1,1,1)
    titleBar.Font = Enum.Font.GothamBold
    titleBar.TextSize = 16
    titleBar.Active = true
    titleBar.Selectable = true

    -- 滚动容器
    local scroll = Instance.new("ScrollingFrame")
    scroll.Parent = window
    scroll.Size = UDim2.new(1,0,1,-35)
    scroll.Position = UDim2.new(0,0,0,35)
    scroll.BackgroundTransparency = 1
    scroll.ScrollBarThickness = 5
    scroll.CanvasSize = UDim2.new(1,0,0,950) -- 增大滚动区域高度

    -- UI 工具函数
    local y = 0

    local function addButton(text, callback)
        local btn = Instance.new("TextButton")
        btn.Parent = scroll
        btn.Size = UDim2.new(1, -10, 0, 35)
        btn.Position = UDim2.new(0,5,0,y)
        btn.BackgroundColor3 = Color3.fromRGB(50,80,120)
        btn.Text = text
        btn.TextColor3 = Color3.new(1,1,1)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 14
        btn.MouseButton1Click:Connect(function() pcall(callback) end)

        local c = Instance.new("UICorner")
        c.Parent = btn
        c.CornerRadius = UDim.new(0.2,0)

        y += 40
        return btn
    end

    local function addToggle(text, def, callback)
        local frame = Instance.new("Frame")
        frame.Parent = scroll
        frame.Size = UDim2.new(1, -10, 0, 35)
        frame.Position = UDim2.new(0,5,0,y)
        frame.BackgroundTransparency = 1
        y += 40

        local lbl = Instance.new("TextLabel")
        lbl.Parent = frame
        lbl.Size = UDim2.new(0,150,1,0)
        lbl.BackgroundTransparency = 1
        lbl.Text = text
        lbl.TextColor3 = Color3.new(1,1,1)
        lbl.Font = Enum.Font.Gotham
        lbl.TextSize = 14

        local toggle = Instance.new("TextButton")
        toggle.Parent = frame
        toggle.Size = UDim2.new(0,70,0,30)
        toggle.Position = UDim2.new(1,-75,0,2.5)
        toggle.BackgroundColor3 = def and Color3.fromRGB(50,150,50) or Color3.fromRGB(150,50,50)
        toggle.Text = def and "开" or "关"
        toggle.TextColor3 = Color3.new(1,1,1)
        toggle.Font = Enum.Font.GothamBold
        toggle.TextSize = 12

        local c = Instance.new("UICorner")
        c.Parent = toggle
        c.CornerRadius = UDim.new(0.2,0)

        toggle.MouseButton1Click:Connect(function()
            local newState = toggle.Text == "关"
            toggle.BackgroundColor3 = newState and Color3.fromRGB(50,150,50) or Color3.fromRGB(150,50,50)
            toggle.Text = newState and "开" or "关"
            callback(newState)
        end)

        return toggle
    end

    local function addInput(text, placeholder, def, callback)
        local frame = Instance.new("Frame")
        frame.Parent = scroll
        frame.Size = UDim2.new(1, -10, 0, 40)
        frame.Position = UDim2.new(0,5,0,y)
        frame.BackgroundTransparency = 1
        y += 45

        local lbl = Instance.new("TextLabel")
        lbl.Parent = frame
        lbl.Size = UDim2.new(0,150,1,0)
        lbl.BackgroundTransparency = 1
        lbl.Text = text
        lbl.TextColor3 = Color3.new(1,1,1)
        lbl.Font = Enum.Font.Gotham
        lbl.TextSize = 14

        local input = Instance.new("TextBox")
        input.Parent = frame
        input.Size = UDim2.new(0,110,0,30)
        input.Position = UDim2.new(0,160,0,5)
        input.BackgroundColor3 = Color3.fromRGB(50,50,50)
        input.Text = def
        input.TextColor3 = Color3.new(1,1,1)
        input.Font = Enum.Font.Gotham
        input.TextSize = 14
        input.PlaceholderText = placeholder

        local btn = Instance.new("TextButton")
        btn.Parent = frame
        btn.Size = UDim2.new(0,60,0,30)
        btn.Position = UDim2.new(0,280,0,5)
        btn.BackgroundColor3 = Color3.fromRGB(50,150,50)
        btn.Text = "应用"
        btn.TextColor3 = Color3.new(1,1,1)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 12

        local c = Instance.new("UICorner")
        c.Parent = btn
        c.CornerRadius = UDim.new(0.2,0)

        btn.MouseButton1Click:Connect(function()
            callback(input.Text)
        end)

        return input
    end

    -- ===================== 添加所有功能 =====================

    -- 摄像机距离
    addInput("摄像机距离", "输入数值", tostring(LocalPlayer.CameraMaxZoomDistance or 128), function(text)
        local v = tonumber(text)
        if v then LocalPlayer.CameraMaxZoomDistance = v end
    end)

    -- 自动 v4
    local autoV4State = false
    local autoV4Task = nil
    addToggle("自动 v4", false, function(state)
        autoV4State = state
        if autoV4Task then task.cancel(autoV4Task); autoV4Task = nil end
        if state then
            autoV4Task = task.spawn(function()
                while autoV4State do
                    callAwakeningRemote()
                    task.wait(1)
                end
            end)
        end
    end)

    -- 快速攻击
    addToggle("快速攻击", _G.FastAttack, function(state)
        if _ENV.rz_FastAttack then
            _ENV.rz_FastAttack.IsRunning = state
            _G.FastAttack = state
        else
            _G.FastAttack = state
        end
    end)

    -- 攻击范围（2500）
    addInput("攻击范围", "1-5000", "2500", function(text)
        local num = tonumber(text) or 2500
        num = math.floor(math.clamp(num, 1, 5000))
        if _ENV.rz_FastAttack then
            _ENV.rz_FastAttack.Distance = num
        else
            if Module.FastAttack then Module.FastAttack.Distance = num end
        end
    end)

    -- 攻速（0.3）
    addInput("攻击速度", "0.0005-2", "0.3", function(text)
        local num = tonumber(text) or 0.3
        if num < MIN_CLICK_DELAY then num = MIN_CLICK_DELAY end
        if num > 2 then num = 2 end
        Settings.ClickDelay = num
    end)

    -- 移动加速
    addInput("移动加速", "输入数值", tostring(getfenv().translateSpeed or 50), function(text)
        local v = tonumber(text)
        if v then getfenv().translateSpeed = v end
    end)

    addToggle("加速开关", false, function(state)
        enableTranslateAccel(state)
    end)

    -- ESP
    addToggle("ESP总开关", ESPConfig.MainSwitch, function(state)
        ESPConfig.MainSwitch = state
        UpdateAllESP()
    end)

    addToggle("ESP名字距离", ESPConfig.ShowNameDistance, function(state)
        ESPConfig.ShowNameDistance = state
        UpdateAllESP()
    end)

    addToggle("ESP血量", ESPConfig.ShowHealth, function(state)
        ESPConfig.ShowHealth = state
        UpdateAllESP()
    end)

    addToggle("ESP射线", ESPConfig.ShowTracer, function(state)
        ESPConfig.ShowTracer = state
        UpdateAllESP()
    end)

    -- 传送
    addButton("传送一海", function()
        pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("TravelMain") end)
    end)

    addButton("传送二海", function()
        pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("TravelDressrosa") end)
    end)

    addButton("传送三海", function()
        pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("TravelZou") end)
    end)

    addButton("天鹅房间", function()
        TeleportTo(Vector3.new(-287.37, 305.81, 592.98))
    end)

    addButton("豪宅", function()
        TeleportTo(Vector3.new(2286.93, 15.06, 910.51))
    end)

    -- 外部脚本
    addButton("飞行脚本", function()
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/kismile236/rjrym/refs/heads/main/fly.lua"))() end)
    end)

    addButton("FPS优化", function()
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/kismile236/rjrym/refs/heads/main/fpsboost"))() end)
    end)

    addButton("HOHO UI", function()
        pcall(function() loadstring(game:HttpGet('https://raw.githubusercontent.com/acsu123/HOHO_H/main/Loading_UI'))() end)
    end)

    -- 新增：飞行功能
    addButton("飞行",function()
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))() end)
    end)

    -- 新增：法天象地功能
    addButton("法天象地",function()
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/kismile36/rjrzhongxing/refs/heads/main/rjr/fatianxiangdi"))() end)
    end)

    -- 悬浮球点击
    floatBtn.MouseButton1Click:Connect(function()
        window.Visible = not window.Visible
        if window.Visible then
            floatBtn.Text = "✕"
            floatBtn.BackgroundColor3 = Color3.fromRGB(200,50,50)
        else
            floatBtn.Text = "☰"
            floatBtn.BackgroundColor3 = Color3.fromRGB(50,100,200)
        end
    end)

    -- 真正的拖动功能（修复版）
    local dragging = false
    local dragStart = nil
    local startPos = nil

    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = window.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            local delta = input.Position - dragStart
            window.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)

    return screenGui
end

-- 创建悬浮球
local gui = createFloatingGui()

-- Insert 键开关
local toggleKey = Enum.KeyCode.Insert
getgenv().ToggleRenJiGui = function()
    if gui then
        gui.Enabled = not gui.Enabled
    end
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == toggleKey then
        if UserInputService:GetFocusedTextBox() then return end
        gui.Enabled = not gui.Enabled
        pcall(function()
            StarterGui:SetCore("SendNotification", {
                Title = "人挤人脚本",
                Text = gui.Enabled and "悬浮球已显示" or "悬浮球已隐藏",
                Duration = 1.5
            })
        end)
    end
end)

-- 启动提示
pcall(function()
    StarterGui:SetCore("SendNotification",{
        Title = "人挤人脚本",
        Text = "悬浮球已加载（按 Insert 隐藏/显示）",
        Duration = 5,
    })
end)

return {
    GUI = gui,
    Toggle = getgenv().ToggleRenJiGui,
    FastAttack = _ENV.rz_FastAttack or Module.FastAttack,
    Settings = Settings,
    ESPConfig = ESPConfig
}
